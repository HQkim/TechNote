# 로드 밸런싱 (Load Balancing)

### 로드 밸런싱이란?

> 컴퓨터 네트워크 기술의 일종으로 둘 혹은 셋 이상의 중앙처리장치 혹은 저장장치와 같은 컴퓨터 자원들에게 작업을 나누는 것

- 인터넷의 발달로 트래픽이 폭발적으로 증가. 성능이 좋은 서버라고 해도 하나의 서버로 모든 트래픽을 감당할 수 없음. 
- 이를 위해 여러 대의 서버를 사용해서 트래픽에 대응하는데, 그 중 일부 서버에 트래픽이 몰리지 않게 분산시켜주는 것이 로드밸런싱
- 말 그대로 부하(=로드)를 분산(=밸런싱) 해주는 것.
- 로드 밸러서는 로드 밸런싱 기술을 제공하는 서비스 또는 장치.



### Scale-up과 Scale-out

![img](06_%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1.assets/%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1_%EC%8A%A4%EC%BC%80%EC%9D%BC.jpg)

- **Scale-up**
  - 서버 자체의 성능을 향상시키는 것
- **Scale-out**
  - 서버 개수를 증가시키는 것
  - **로드 밸런싱**이 반드시 필요!



### 로드 밸런싱의 기본 기능

1. **Health Check (상태 확인)**
   - 서버들에 대한 주기적인 Health Check를 통해 서버들의 장애 여부를 판단하여, 정상 동작 중인 서버로만 트래픽을 보냄
   - L3 체크: ***ICMP**를 이용하여 서버의 IP 주소가 통신 가능한 상태인지를 확인
   - L4 체크: TCP는 3 Way-Handshaking을 기반으로 통신하는데, 이러한 TCP의 특성을 바탕으로 각 포트 상태를 체크하는 방식
   - L7 체크: 어플리케이션 계층에서 체크를 수행. 실제 웹페이지에 통신을 시도하여 이상 유무를 파악
2. **Tunneling (터널링)**
   - 데이터 스트림을 인터넷 상에서 가상의 파이프를 통해 전달시키는 기술로, 패킷 내에 터널링할 대상을 캡슐화시켜 목적지까지 전송
   - 연결된 상호 간에만 캡슐화된 패킷을 구별해 캡슐화를 해제할 수 있음
   - 실제 가상 IP 주소로 향하는 요구 패킷이 로드밸런싱 서버로 전달 되면 로드밸런싱 서버에서 패킷의 목적지 주소와 포트를 검사하여 가상 서버 정책과 일치 하면 스케줄링에 따라 실제 작업 서버로 전달하게 된다.
     이때 패킷을 일반적인 스트림(Stream) 방식으로 전달하는 것이 아닌 캡슐 형식으로 싸서 전달하게 된다.

3. **NAT (Network Address Translation)**

   - 내부 네트워크에서 사용하는 **사설 IP 주소**와 로드밸런서 외부의 **공인 IP 주소** 간의 **변환 역할**

   - 로드밸런싱 관점에서는 여러 개의 호스트가 하나의 공인 IP 주소(VLAN or VIP)를 통해 접속하는 것이 주 목적

   - **SNAT (Source Network Address Translation)** : 내부에서 외부로 트래픽이 나가는 경우
     내부 사설 IP 주소 -> 외부 공인 IP 주소로 변환

   - **DNAT (Destination Network Address Translation)** : 외부에서 내부로 트래픽이 들어오는 경우

     외부 공인 IP 주소 -> 내부 사설 IP 주소로 변환

4. **DSR (Direct Server Routing)**

   - 서버에서 클라이언트로 되돌아가는 경우, 목적지를 클라이언트로 설정한 다음 네트워크 장비나 로드밸런서를 거치지 않고 바로 클라이언트를 찾아가는 방식. 로드밸런서의 부하를 줄여줄 수 있는 장점이 있음.

*ICMP: Internet Control Message Protocol. 패킷 전송에 실패했을 때 에러가 났음을 알림과 동시에, 해결 가능한 힌트를 제공하는 메시징 프로토콜. TCP/IP의 IP 계층에서 동작.



### 로드 밸런싱의 종류

로드 밸런싱의 종류는 OSI 7계층에 따라 나뉨.

- **L4 로드밸런서**
  - 4계층(Transport, 전송 계층)이나 3계층(Network, 네트워크 계층)의 정보를 바탕으로 로드를 분산
  - **IP 주소, 포트번호, MAC 주소, 전송 프로토콜** 등에 따라 트래픽 분산
  - 장점으로는 패킷의 내용을 확인하지 않고 로드를 분산하므로 **속도가 빠르고 효율이 높음**
    데이터의 내용을 **복호화할 필요가 없기에** 안전
    L7 로드밸런서보다 **가격이 저렴**
  - 단점으로는 패킷의 내용을 살펴볼 수 없으므로 **섬세한 라우팅 불가**
    사용자의 IP가 수시로 바뀌는 경우라면, 연속적인 서비스를 제공하기 어려움
- **L7 로드밸런서**
  - 7계층(Application 계층)에서 로드를 분산
  - **HTTP 헤더, 쿠기, URL** 등과 같은 사용자 요청을 기준으로 트래픽을 분산하는 것이 가능
  - L4 로드밸런서의 기능에 더하여, 패킷의 내용을 확인하고 그 내용에 따라 로드를 특정 서버에 분배하는 것이 가능
  - 장점으로는 **더 섬세한 라우팅**이 가능하고, 캐싱(Caching)기능을 제공하고, 비정상적인 트래픽을 사전에 필터링할 수 있어 **서비스 안정성이 높음**
  - 단점으로는 L4 로드밸런서에 비해 **비싸고**, **패킷의 내용을 복호화**하여야 하므로 더 높은 비용을 지불해야하며, 클라이언트가 로드밸런서와 인증서를 공유해야하기 때문에, 공격자가 로드밸런서를 통해 클라이언트의 데이터에 접근할 수 있는 **보안상의 위험성** 존재



### 로드 밸런싱 알고리즘

- **라운드 로빈 방식(Round Robin Method)**

  서버에 들어온 요청을 순서대로 돌아가며 배정하는 방식. 클라이언트의 요청을 순서대로 분배하기 때문에 여러 대의 서버가 동일한 스펙을 갖고 있고, 서버와의 연결(세션)이 오래 지속되지 않는 경우에 활용하기 적합

- **가중 라운드로빈 방식(Weighted Round Robin Method)**

  각각의 서버마다 가중치를 매기고 가중치가 높은 서버에 클라이언트 요청을 우선적으로 배분. 주로 서버의 트래픽 처리 능력이 상이한 경우 사용되는 방식. ex) A라는 서버가 5라는 가중치를 갖고 B라는 서버가 2라는 가중치를 가질 경우, 로드밸런서는 라운드로빈 방식으로 A서버에 5개 B 서버에 2개의 요청을 전달

- **IP 해시 방식(IP Hash Method)**

  클라이언트의 IP 주소를 특정 서버로 매핑하여 요청을 처리하는 방식. 사용자의 IP를 해싱해(Hashing: 임의의 길이를 지닌 데이터를 고정된 길이의 데이터로 매핑하는 것) 로드를 분배하기 때문에 사용자가 항상 동일한 서버로 연결되는 것을 보장. 접속자 수가 많을수록 분산 및 효율이 뛰어남

- **최소 연결 방식(Least Connection Method)**

  요청이 들어온 시점에 가장 적은 연결상태를 보이는 서버에 우선적으로 트래픽을 배분. 자주 세션이 길어지거나, 서버에 분배된 트래픽들이 일정하지 않은 경우에 적합한 방식

- **최소 리스폰타임(Least Response Time Method)**

  서버의 현재 연결 상태와 응답시간(Response Time: 서버에 요청을 보내고 최초 응답을 받을 때까지 소요되는 시간)을 모두 고려하여 트래픽을 배분. 가장 적은 연결 상태와 가장 짧은 응답시간을 보이는 서버에 우선적으로 로드를 배분하는 방식.



### 참고

[로드밸런서(Load Balancer)의 개념과 특징](https://m.post.naver.com/viewer/postView.naver?volumeNo=27046347&memberNo=2521903)

[로드 밸런싱(Load Balancing) 종류와 알고리즘](https://dev.classmethod.jp/articles/load-balancing-types-and-algorithm/)

[[네트워크] 로드밸런싱의 개념 및 기법 설명](https://co-no.tistory.com/22)